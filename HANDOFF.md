# Handoff: 2026-02-07 (Session 109)

## GOAL: Fill `fundamental_formula` sorry (the #1 priority)

**File**: `AfTests/Jordan/FundamentalFormula.lean:259`
**Statement**: `U (U a b) x = U a (U b (U a x))` for all `a b x : J` in any `JordanAlgebra J`
**Route**: Macdonald's theorem (H-O 2.4.13) lifts `special_fundamental_formula` to all Jordan algebras

## What EXISTS (all sorry-free unless noted)

### Macdonald infrastructure (`AfTests/Jordan/Macdonald/`)

| File | LOC | Sorries | What it does |
|------|-----|---------|-------------|
| FreeAlgebra.lean | 122 | 0 | FreeMagma, FreeNAAlg (ℝ-algebra on binary trees) |
| FreeJordan.lean | 177 | 0 | FreeJordanAlg = FreeNAAlg/JordanCong (2 generators x,y) |
| FreeSpecialJordan.lean | 207 | 0 | `evalAssoc : A → A → FreeJordanAlg → A` (eval into assoc algebras) |
| UBilinear.lean | 113 | 0 | `U_bilinear` linear map, simp lemmas |
| OperatorId.lean | 181 | 0 | Operator identities (2.47)-(2.49) |
| GeneratorLemma.lean | 102 | 0 | Lemma 2.4.23: U_{a,b} generation |
| Monomial.lean | 164 | 0 | M_word, M_eval, induction principles |
| MonoBlock.lean | 215 | 0 | FreeAssocMono type, weight, prependX/Y |
| FJOperators.lean | 105 | 0 | FreeJordanAlg.pow, T, U, U_bilinear on FJ |
| SpecialFF.lean | 100 | 0 | **`special_fundamental_formula`**: FF in all assoc algebras |
| MonomialFJ.lean | 131 | 0 | M_{p,q} as FreeJordanAlg elements |
| MOperator.lean | 213 | 0 | `M_op` recursive definition, termination fully proved |
| MOperatorProperties.lean | 122 | 0 | Properties (ii) M_{1,1}=id, (iii) U factorization, (iv) U_bilinear symmetrization |
| TensorSetup.lean | 170 | 0 | FA, FA3, evalFA, gamma_elem, gamma_mac (correct gamma) |

### Key theorems already proved

- **`special_fundamental_formula`** (SpecialFF.lean): For any assoc algebra A and a',b' : A:
  `evalAssoc a' b' (U (U x y) w) = evalAssoc a' b' (U x (U y (U x w)))` for all w : FreeJordanAlg
- **`M_op_one_one`**: M(1,1)(v) = v (property ii)
- **`M_op_xCons_xCons`/`M_op_yCons_yCons`**: M(x^k·p, x^k·q) = U_{x^k} M(p,q) (property iii)
- **`M_op_U_bilinear_yCons`/`M_op_U_bilinear_xCons`**: U_{x^k,y^l}M = ½(M+M) (property iv)
- **`gamma_mac`** (TensorSetup.lean): `gamma_mac(p,q) = ½(pzq* + qzp*)` in FA3
- **`gamma_mac_comm`**: gamma_mac is symmetric

## What NEEDS to be built (3 remaining steps)

### Step 15: Gamma injectivity (af-i706, P2)

**Goal**: Prove `gamma_mac` is injective on symmetric tensors of FA ⊗ FA.

**Mathematical argument** (H-O 2.4.25):
- Define `full_gamma(p⊗q) = p·z·q*` (without symmetrization). This is injective because
  monomials in FA3 containing exactly one z uniquely determine p (left of z) and q (right of z, reversed).
- On symmetric tensors (where swap(t)=t): `gamma_mac(t) = full_gamma(t)` (since symmetrizing an
  already-symmetric tensor is identity). So gamma_mac is injective on symmetric tensors.
- **Key Mathlib API**: `FreeAlgebra.basisFreeMonoid` gives a basis of FA as an ℝ-module.
  Use `Basis.tensorProduct` for FA⊗FA basis. Injectivity via linear independence of monomials.

**WARNING**: The old `gamma_jordan_product` theorem (claiming `γ(u∘v) = ½(γ(u)·γ(v)+γ(v)·γ(u))`
with `gamma_elem a = a⊗1+1⊗a`) was **FALSE**. The difference is `a⊗b+b⊗a ≠ 0`.
It was removed in this session. The correct gamma is `gamma_mac` which maps into FA3 (3 generators).

### Step 16: Macdonald's theorem (af-g2kb, P1)

**Goal**: State and prove Macdonald's theorem (H-O 2.4.13).

**Statement** (multiplication operator form): If M is a multiplication operator in 2 variables
(x,y), and M(v) = 0 for all v when evaluated in every special Jordan algebra, then M(v) = 0
for all v in every Jordan algebra.

**Equivalent clean statement**: `evalFA : FreeJordanAlg → FA` is injective, where
`evalFA = FreeJordanAlg.evalAssoc FA.x FA.y` and `FA = FreeAlgebra ℝ (Fin 2)`.

**Proof structure** (H-O 2.4.25, two parts):

*Part A — Surjectivity*: Every multiplication operator equals M_t for some symmetric tensor t.
- The range E of `t ↦ M_t` contains Id (by M_{1,1}=id, property ii)
- E is closed under U_{x^k} (by property iii) and U_{x^k,y^l} (by property iv)
- By Lemma 2.4.23 (GeneratorLemma.lean), the multiplication algebra is generated by
  {U_{a,b} : a,b ∈ {1,x,y}}, so E = entire multiplication algebra

*Part B — Injectivity*: gamma_mac on symmetric tensors is injective (Step 15).

*Conclusion*: Suppose M_t vanishes on all special JAs. Then M_t(z) = 0 in FS{x,y,z}
(free special Jordan algebra on 3 generators). By property (i), M_t(z) = gamma_mac(t).
So gamma_mac(t) = 0, hence t = 0 by injectivity, hence M_t = 0.

**Note on property (i)**: `M_{p,q}(z) = ½(pzq* + qzp*)` in FA{x,y,z}. This hasn't been proved
yet. It follows by induction on weight using properties (iii), (iv), and base cases. The z here
is the THIRD generator of FA3 = FreeAlgebra ℝ (Fin 3), acting as a "test element".

### Step 17: Fill fundamental_formula (af-gzm1, P1)

**Goal**: Use Macdonald to fill the `fundamental_formula` sorry.

**Proof sketch**:
1. `special_fundamental_formula` (proved) shows FF holds in all associative algebras
2. The difference `U_{U_a(b)} - U_a U_b U_a` is a multiplication operator in a,b (linear in x)
3. By Macdonald's theorem, this operator is zero in all Jordan algebras
4. **Subtlety**: FreeJordanAlg has only 2 generators (x,y). The FF involves 3 variables (a,b,x).
   But x appears linearly, so `U_{U_a(b)} - U_a U_b U_a` is a multiplication operator in (a,b)
   applied to x. Macdonald applies because the operator acts on an arbitrary element, including
   the "free" third generator z of FA3.
5. **Connection to general J**: For any Jordan algebra J and a,b,c ∈ J, let
   φ: FJ{x,y,z} → J with φ(x)=a, φ(y)=b, φ(z)=c. Since FF holds in FJ{x,y,z}, it holds in J.
   (We don't have FJ on 3 generators explicitly, but the Macdonald argument works directly
   at the operator level using M_op applied to an arbitrary v : FreeJordanAlg.)

## CRITICAL TRAP TO AVOID

**DO NOT** try to prove `gamma_jordan_product` with `gamma_elem a = a⊗1+1⊗a`.
It is mathematically **FALSE**. The correct gamma for Macdonald is `gamma_mac` in TensorSetup.lean
which maps into FA3 (3-generator free algebra) using `½(pzq*+qzp*)`.

## File map

```
AfTests/Jordan/
├── Basic.lean              -- JordanAlgebra class
├── FundamentalFormula.lean -- fundamental_formula (sorry at line 259) ← FILL THIS
├── Quadratic.lean          -- U operator definition and properties
├── LinearizedJordan.lean   -- Linearized identities, power associativity
├── OperatorIdentities.lean -- Commutator identities
├── FormallyReal/Square.lean -- isPositiveSqrt_unique (sorry, unrelated)
├── Classification/         -- isSimple sorries (unrelated)
└── Macdonald/
    ├── UBilinear.lean      -- U_{a,b} linear map
    ├── OperatorId.lean     -- (2.47)-(2.49)
    ├── GeneratorLemma.lean -- Lemma 2.4.23
    ├── FreeAlgebra.lean    -- FreeMagma, FreeNAAlg
    ├── FreeJordan.lean     -- FreeJordanAlg (2 generators)
    ├── FreeSpecialJordan.lean -- evalAssoc
    ├── SpecialFF.lean      -- special_fundamental_formula (PROVED)
    ├── Monomial.lean       -- M_word, M_eval
    ├── MonoBlock.lean      -- FreeAssocMono (alternating block monomials)
    ├── FJOperators.lean    -- T, U, U_bilinear on FreeJordanAlg
    ├── MonomialFJ.lean     -- M_{p,q} as FJ elements
    ├── MOperator.lean      -- M_op recursive definition (0 sorries!)
    ├── MOperatorProperties.lean -- Properties (ii)-(iv) (0 sorries!)
    └── TensorSetup.lean    -- FA, FA3, evalFA, gamma_mac (0 sorries!)
```

## Build & sorries

**Build**: `lake build AfTests 2>&1 | tail -40` — PASSES (1915 jobs)
**Sorries**: 4 total (FundamentalFormula, Square, 2× Classification)

## Beads issues

- af-i706 (P2): Step 15 — Gamma injectivity
- af-g2kb (P1): Step 16 — Macdonald theorem
- af-gzm1 (P1): Step 17 — Fill fundamental_formula
- af-uzj5 (P2, in_progress): Step 14 — Tensor setup (mostly done)

## Reference

Book: `examples3/Jordan Operator Algebras/joa-m/joa-m.md`
- Macdonald's theorem: 2.4.13 (line ~1063)
- M_{p,q} construction: 2.4.24 (line ~1215)
- Proof of Macdonald: 2.4.25 (line ~1379)
- Star involution: 2.3.5 (line ~859)
- Mathlib research: `memory/macdonald-steps14-17.md`

---

## Previous Sessions

### Session 108: Steps 11+12 (M_op definition)
### Session 106: Steps 7+10 (SpecialFF + MonomialFJ)
### Session 105: Steps 6+9 (FreeSpecialJordan + GeneratorLemma)
### Session 104: Steps 3+5 (OperatorId + FreeJordan)
### Session 102: Steps 1+4+8 (UBilinear + FreeAlgebra + Monomial)
